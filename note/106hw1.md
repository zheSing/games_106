descriptor



VertexInputDescription

- binding description

  描述buffer，提供给binding point

  - binding position
  - stride
  - binding rate（[instance rendering](https://zhuanlan.zhihu.com/p/54575986)）

- attribute description

  - binding position
  - location (shader中)
  - format
  - offset



Descriptor





- 模板缓冲区
- instance rendering
- BRDF，PBR，Microfacet
- tiled base 内存结构



基本流程

- 初始化swapchain
  - initSwapchain
- 指令？：command pool
  - createCommandPool (vkCreateCommandPool)
- 交换链：setupSwapChain
- 指令缓冲：createCommandBuffers
  - 关系到 VkCommandBuffer
  - 关系到 swapChain.imageCount
- 同步：createSynchronizationPrimitives
  - 关系到 fence
- 深度/模板缓冲：setupDepthStencil
  - 建立image、申请内存、建立image view
- renderpass：setupRenderPass
  - 附件：color、depthStencil
  - subpass
  - dependency
- 流水线缓存：createPipelineCache
  - 
- 帧缓冲：setupFrameBuffer
  - 附件：依赖image view创建

- prepare uniform buffer
  - create buffer for uniform
- descriptor
  - 描述符池：VkDescriptorPoolSize、VkDescriptorPoolCreateInfo，创建VkDescriptorPool
  - 描述符集：创建 VkDescriptorSetLayout（以set为数量）、pushConstant
  - pipeline：sets + pushConstant
  - 描述符集内存：vkAllocateDescriptorSets（需要符池、符集）、vkUpdateDescriptorSets
  - 描述符集句柄：VkDescriptorSet
- pipeline
  - vertexInput、shaderStage、renderPass……等等
  - 写入 VkPipeline
- build
  - 视口、裁切
  - vkBeginCommandBuffer
  - renderPassBeginInfo
  - vkCmdBeginRenderPass
  - vkCmdBindDescriptorSets
  - vkCmdBindPipeline
  -  (vkCmdBindVertexBuffers, vkCmdBindIndexBuffer, )
  - ...draw(vkCmdDraw/vkCmdDrawIndexed)
  - vkCmdNextSubpass
  - ...
  - vkCmdEndRenderPass
  - vkEndCommandBuffer



#### Animation

- 加载 glTF 动画数据

  参考 examples/gltfskinning，但不需要蒙皮数据

  - 这里我使用 ssbo，在加载时顺便创建 buffer （VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT | VK_MEMORY_PROPERTY_HOST_COHERENT_BIT）

    每个顶点需要一个4*4矩阵来存储变换，使用ssbo而不是uniform（todo）



- shader

  ```glsl
  layout(set = 2, binding = 0) readonly buffer TransformMatrices {
  	mat4 transformMatrices[];
  }Trans;
  ```

  在 setupDescriptorSet 中加入新的描述符集，类型为 VK_DESCRIPTOR_TYPE_STORAGE_BUFFER

  

- update

  - 计算动画数据，得到矩阵
  - 更新 ssbo
  - 需要注意的：层级关系




#### PBR

- load image、material
- descriptor 引用 images
- descriptor set 时 绑定上对应的 material



#### Tone Mapping

- 多个 pass
- 多个 subpass

